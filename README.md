# Dynamic LP Hook

A smart contract that enhances Uniswap V4 liquidity provision by automatically reallocating inactive liquidity to lending protocols. Built with Arbitrum Stylus in Rust.

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

## Overview

The Dynamic LP Hook is designed to maximize yield for liquidity providers by creating a positive feedback loop:
1. When price moves outside a configured range, liquidity is moved to lending protocols
2. Lending fees compound while liquidity is inactive
3. When price returns to range, liquidity moves back to LP with increased size
4. Larger positions generate more fees, creating a virtuous cycle

## Features

- **TWAP-based Price Monitoring**: Uses time-weighted average price to determine optimal reallocation points
- **Dynamic Reallocation**: Automatically moves liquidity between LP and lending positions
- **Fee Optimization**: Compounds lending fees while maintaining LP exposure
- **Gas Efficient**: Built with Arbitrum Stylus for optimal performance
- **Configurable Parameters**: Adjustable observation period, price range, and reallocation timing

## Architecture

For detailed information about the project's architecture, components, and design decisions, see the [Architecture Documentation](docs/architecture.md).

## Getting Started

### Prerequisites

- Rust toolchain (see `rust-toolchain.toml`)
- Arbitrum Stylus CLI
- Git

### Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/dynamic-lp-hook.git
cd dynamic-lp-hook
```

2. Build the project:
```bash
cargo build
```

3. Run tests:
```bash
cargo test --locked --features std --lib
```

4. Check contract compatibility:
```bash
cargo stylus check
```

### Deployment

To deploy the contract to Arbitrum Stylus:

```bash
cargo stylus deploy --private-key <your-private-key>
```

## Usage

### Initialization

```rust
let hook = DynamicLPHook::new();
hook.initialize(
    lending_protocol_address,
    observation_period,    // e.g., 3600 (1 hour)
    min_reallocation_time, // e.g., 1800 (30 minutes)
    price_range,          // e.g., 100 (1% in basis points)
)?;
```

### Key Functions

- `update_twap(price)`: Update the time-weighted average price
- `check_and_reallocate(current_price)`: Check if position needs reallocation
- `collect_lending_fees()`: Collect and compound lending fees
- `move_to_lp_if_in_range(current_price)`: Return liquidity to LP if price is in range

## Testing

The project includes comprehensive tests for all major functionality:

```bash
cargo test --locked --features std --lib
```

## Proof of run 
### tests
```
running 9 tests
test tests::test_initialization ... ok
test tests::test_set_min_compound_amount ... ok
test tests::test_auto_compound_disabled ... ok
test tests::test_handles_edge_cases ... ok
test tests::test_respects_min_reallocation_time ... ok
test tests::test_updates_twap ... ok
test tests::test_auto_compound_lp_fees ... ok
test tests::test_lp_fee_collection ... ok
test tests::test_checks_and_reallocates ... ok
``` 

### stylus correctness
```
❯ cargo stylus check
Building project with Cargo.toml version: 0.2.0
   Compiling dynamic-lp-hook v0.2.0 (/Users/roule/Code/DeFi/Uniswap/stylus/dynamic-lp-hook)
    Finished `release` profile [optimized] target(s) in 1.22s
stripped custom section from user wasm to remove any sensitive data
contract size: 16.8 KB
wasm size: 59.8 KB
File used for deployment hash: ./Cargo.lock
File used for deployment hash: ./Cargo.toml
File used for deployment hash: ./rust-toolchain.toml
File used for deployment hash: ./src/lib.rs
File used for deployment hash: ./src/main.rs
project metadata hash computed on deployment: "a59399ab59879ecb57624b6731ef34b1246e43bf666a283e3649e6f07ba9ded0"
stripped custom section from user wasm to remove any sensitive data
contract size: 16.8 KB
wasm data fee: 0.000121 ETH (originally 0.000101 ETH with 20% bump)
```


```
❯ cargo stylus export-abi
/**
 * This file was automatically generated by Stylus and represents a Rust program.
 * For more information, please see [The Stylus SDK](https://github.com/OffchainLabs/stylus-sdk-rs).
 */

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.23;

interface IDynamicLPHook  {
    function initialize(address lending_protocol, uint256 observation_period, uint256 min_reallocation_time, uint256 price_range, bool auto_compound_enabled, uint256 min_compound_amount) external;

    function updateTwap(uint256 price) external;

    function checkAndReallocate(uint256 current_price) external;

    function collectLendingFees() external returns (uint256);

    function moveToLpIfInRange(uint256 current_price) external;

    function collectLpFees() external returns (uint256);

    function autoCompoundLpFees() external;

    function setAutoCompound(bool enabled) external;

    function setMinCompoundAmount(uint256 amount) external;

    error InvalidTWAP();

    error InvalidLendingProtocol();

    error InvalidAmount();

    error InvalidRange();

    error AutoCompoundDisabled();
}
```

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

- [Arbitrum Stylus](https://docs.arbitrum.io/stylus)
- [Uniswap V4](https://docs.uniswap.org/contracts/v4/overview)
- [Rust](https://www.rust-lang.org/)
